<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">

    <title>Hotel chain</title>
    <meta content="" name="descriptison">
    <meta content="" name="keywords">

    <!-- Favicons -->
    <link href="assets/img/favicon.png" rel="icon">
    <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Raleway:300,300i,400,400i,500,500i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">

    <!-- Vendor CSS Files -->
    <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/vendor/icofont/icofont.min.css" rel="stylesheet">
    <link href="assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
    <link href="assets/vendor/venobox/venobox.css" rel="stylesheet">
    <link href="assets/vendor/line-awesome/css/line-awesome.min.css" rel="stylesheet">
    <link href="assets/vendor/owl.carousel/assets/owl.carousel.min.css" rel="stylesheet">
    <link href="assets/vendor/aos/aos.css" rel="stylesheet">

    <!-- Template Main CSS File -->
    <link href="assets/css/style.css" rel="stylesheet">
    <style type="text/css">
        #intro-sec .intro-container {
            position: absolute;
            bottom: 0;
            top: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            text-align: center;
            color: #fff;
        }

        #intro-sec h1 {
            margin: 0 0 10px 0;
            font-size: 48px;
            font-weight: 700;
            line-height: 56px;
        }
    </style>

</head>

<body>

<!-- ======= Header ======= -->
<header id="header" class="fixed-top">
    <div class="container d-flex">

        <div class="logo mr-auto">
            <h1 class="text-light"><a href="index.html">Black Clover</a></h1>
            <!-- Uncomment below if you prefer to use an image logo -->
            <!-- <a href="index.html"><img src="assets/img/logo.png" alt="" class="img-fluid"></a>-->
        </div>

        <nav class="nav-menu d-none d-lg-block">
            <ul>
                <li><a href="index.html">Home</a></li>


                <li><a href="about.html">About</a></li>
                <li><a href="rooms.html">Rooms</a></li>
                <li><a href="services.html">Services</a></li>
                <li><a href="seasons.html">Seasons</a></li>

                <li class="get-started"><a class='signup-btn' href="http://localhost:8080/hotel_system_war/register.html"></a></li>
                <li class="get-started"><a class='login-btn' href="http://localhost:8080/hotel_system_war/login.html"></a></li>
                <li class="active" ><a class='my-profile' href="profile.html"></a></li>
                <li><a class='logout-btn' href=""></a></li>
            </ul>
        </nav><!-- .nav-menu -->

    </div>
</header><!-- End Header -->


<section id="intro-sec">
    <div class="intro-container" style='background: url("assets/img/hero-bg.jpg") top center;' data-aos="fade-down">
        <h1>Black Clover Hotel Chain</h1>
        <h3>My Profile Section</h3>
    </div>
</section>

<main id="main">


    <section class="services section-bg">
        <div class="container">

            <div class="section-title pt-5" data-aos="fade-up">
                <h2>My Profile</h2>
                <h3 class="welcome">Welcome</h3>
                <h4 class="my-name" style="color: black;"></h4>

                <div id="season">

                </div>

                <div id="profile"></div>

                <h3 class="total_price"></h3>

            </div>

        </div>
    </section><!-- End Services Section -->


</main><!-- End #main -->

<!-- ======= Footer ======= -->
<footer id="footer">
    <div class="footer-top">
        <div class="container">
            <div class="row">

                <div class="col-lg-3 col-md-6 footer-links">
                    <h4>Black Clover</h4>
                    <ul>
                        <li><a href="#">Home</a></li>
                        <li><a href="#">About us</a></li>
                        <li><a href="#">Services</a></li>
                        <li><a href="#">Terms of service</a></li>
                        <li><a href="#">Privacy policy</a></li>
                    </ul>
                </div>

                <div class="col-lg-3 col-md-6 footer-contact">
                    <h4>Contact Us</h4>
                    <p>
                        Kabanbay 58 ave <br>
                        Nursultan<br>
                        Kazakhstan <br>
                        <strong>Phone:</strong> +77777777<br>
                        <strong>Email:</strong> info@example.com<br>
                    </p>

                    <div class="social-links">
                        <a href="#" class="twitter"><i class="icofont-twitter"></i></a>
                        <a href="#" class="facebook"><i class="icofont-facebook"></i></a>
                        <a href="#" class="instagram"><i class="icofont-instagram"></i></a>
                        <a href="#" class="google-plus"><i class="icofont-skype"></i></a>
                        <a href="#" class="linkedin"><i class="icofont-linkedin"></i></a>
                    </div>

                </div>

                <div class="col-lg-3 col-md-6 footer-newsletter">
                    <form action="" method="post">
                        <input type="email" name="email" placeholder="Enter your email address for promotion and news"><input type="submit" value="Subscribe">
                    </form>
                </div>

            </div>
        </div>
    </div>


</footer><!-- End Footer -->

<a href="#" class="back-to-top"><i class="icofont-simple-up"></i></a>




<!-- Vendor JS Files -->
<script src="assets/vendor/jquery/jquery.min.js"></script>
<script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="assets/vendor/jquery.easing/jquery.easing.min.js"></script>
<script src="assets/vendor/php-email-form/validate.js"></script>
<script src="assets/vendor/waypoints/jquery.waypoints.min.js"></script>
<script src="assets/vendor/counterup/counterup.min.js"></script>
<script src="assets/vendor/venobox/venobox.min.js"></script>
<script src="assets/vendor/owl.carousel/owl.carousel.min.js"></script>
<script src="assets/vendor/isotope-layout/isotope.pkgd.min.js"></script>
<script src="assets/vendor/aos/aos.js"></script>

<!-- Template Main JS File -->
<script src="assets/js/main.js"></script>

<script>
    // gives date difference in days
    function DateDiff(date1, date2) {
        var datediff = date1.getTime() - date2.getTime(); //store the getTime diff - or +
        return (datediff / (24*60*60*1000)); //Convert values to -/+ days and return value
    }


    function displayDeskClerkProfile(profile) {
        var user_email;
        var check_in;
        var check_out;
        var guestcount;
        var reservationDate;
        var booking_status;
        var room_title;
        var room_price;
        var room_image;
        var room_description;
        var hotel_name;

        $('.my-name').append(profile[0].firstname + ' ' + profile[0].lastname);

        $("#profile").html("");

        for(var i = 0; i < profile.length; i++) {

            user_email = profile[i].user_email;
            check_in = profile[i].check_in;
            check_out = profile[i].check_out;
            guestcount = profile[i].guestcount;
            reservationDate = profile[i].reservationDate;
            booking_status = profile[i].booking_status;
            room_title = profile[i].room_title;
            room_price = profile[i].room_price;
            room_image = profile[i].room_image;
            room_description = profile[i].room_description;
            hotel_name = profile[i].hotel_name;

            var iscancelled = booking_status.split(' ')[0] === 'CANCELLED';

            var html = `<div class="col py-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-text">Hotel Name: ${hotel_name}</h5>
                                    <h5 class="card-text">Email: ${user_email}</h5>
                                    <p class="card-text">Check-in Date: ${check_in}</p>
                                    <p class="card-text">Check-out Date: ${check_out}</p>
                                </div>
                                <img class="card-img-top" src="${room_image}">
                                <div class="card-body">
                                    <h5 class="card-title">${room_title}</h5>
                                    <p class="card-text">Price $${room_price}/day</p>
                                    <p class="card-text">${room_description}</p>
                                    <p class="card-text">Reservation Date: ${reservationDate}</p>
                                    <h5 class="card-text">Booking Status: ${booking_status}</h5>
                                    ${ iscancelled ? "" : `<button class="btn btn-primary confirm-booking-btn" type="submit" id="booking-${i+1}">Confirm booking</button>`}
                                    ${ iscancelled ? "" : `<button class="btn btn-danger cancel-booking-btn" type="submit" id="cancel-booking-${i+1}">Cancel booking</button>` }
                                </div>
                            </div>
                       </div>`;
            $('#profile').append(html);
        }
    }



    // display rooms using using JQuery and Bootstrap 4 Card
    function displayProfile(profile) {
        var total_price = 0;
        var total_days;

        var check_in;
        var check_out;
        var guestcount;
        var reservationDate;
        var booking_status;
        var room_title;
        var room_price;
        var room_image;
        var room_description;
        var hotel_name;

        var season_name;
        var season_coefficient;

        $('.my-name').html(profile[0].firstname + ' ' + profile[0].lastname);
        if(profile[0].message) {
            $('.message').html(profile[0].message);
            return;
        }


        for(var i = 0; i < profile.length; i++) {

            season_name = profile[i].season_name;
            season_coefficient = profile[i].season_coefficient;

            if(season_name) { console.log(season_name + ' ' + season_coefficient); }

            check_in = profile[i].check_in;
            check_out = profile[i].check_out;
            guestcount = profile[i].guestcount;
            reservationDate = profile[i].reservationDate;
            booking_status = profile[i].booking_status;
            room_title = profile[i].room_title;
            room_price = profile[i].room_price;
            room_image = profile[i].room_image;
            room_description = profile[i].room_description;
            hotel_name = profile[i].hotel_name;

            total_days = DateDiff(new Date(check_in), new Date(check_out));
            total_price += room_price * total_days;

            var html = `<div class="col py-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-text">Hotel Name: ${hotel_name}</h5>
                                    <p class="card-text">Check-in Date: ${check_in}</p>
                                    <p class="card-text">Check-out Date: ${check_out}</p>
                                </div>
                                <img class="card-img-top" src="${room_image}">
                                <div class="card-body">
                                    <h5 class="card-title">${room_title}</h5>
                                   ${ season_name ? `<p class="card-text" style="text-decoration: line-through;">Price $${room_price}/day</p>
                                                      <p class="card-text">Price $${room_price * season_coefficient}/day <strong>(${season_name})</strong></p>` : `<p class="card-text">Price $${room_price}/day</p>`}

                                    <p class="card-text">${room_description}</p>
                                    <p class="card-text">Reservation Date: ${reservationDate}</p>
                                    <h5 class="card-text">Booking Status: ${booking_status}</h5>
                                </div>
                            </div>
                        </div>`;

            $('#profile').append(html);
        }

        $('.total_price').html('Total Price: $' +  Math.abs(total_price));
    }

    function displayAdminProfile(profile) {
        var employee_email;
        var firstname;
        var lastname;
        var gender;
        var salary;
        var address;
        var working_schedule;
        var hotel_name;

        $('#profile').html("");
        for(var i = 0; i < profile.length; i++) {
            employee_email = profile[i].employee_email;
            firstname = profile[i].firstname;
            lastname = profile[i].lastname;
            gender = profile[i].gender;
            salary = profile[i].salary;
            address = profile[i].address;
            working_schedule = profile[i].working_schedule;
            hotel_name = profile[i].hotel_name;

            var html = `<div class="col py-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Email: ${employee_email}</h5>
                                    <p class="card-text">Name: ${firstname} ${lastname}</p>
                                    <p class="card-text">Gender: ${gender}</p>
                                    <p class="card-text">Salary: $${salary}</p>
                                    <p class="card-text">Address: ${address}</p>
                                    <label>Working schedule: </label>
                                    <input id="schedule-${i+1}" type="text" value="${working_schedule}">
                                    <p class="card-text">Hotel Name: ${hotel_name}</p>
                                    <button class="btn btn-primary change-schedule-btn" type="submit" id="employee-${i+1}">Change the working schedule</button>
                                </div>
                            </div>
                        </div>`;




            $('#profile').append(html);

        }

        var seasonHtml = `<div class="booking-form-box">
                            <h5 style="color: black;">Create New Season Prices </h5>

                            <input id="season-name" type="text" class="custom-select" placeholder="Season Name:"><br>

                            <input id="start-date" type="date" class="form-control select-date" placeholder="Start Date: ">
                            <input id="end-date" type="date" class="form-control select-date" placeholder="End Date: ">

                            <input id="coefficient" type="number" placeholder="coefficient" class="form-control" >
                            <button id="btn-set-season" type="submit" class="btn btn-primary">Set the Season Prices</button>
                            <button id="btn-cancel-season" type="submit" class="btn btn-danger">Cancel the Season Prices</button>
                        </div>`;
        $('#season').html(seasonHtml);
    }

    function displayEmployeeProfile(profile) {
        var employee_email;
        var firstname;
        var lastname;
        var gender;
        var salary;
        var address;
        var working_schedule;
        var hotel_name;

        $('#profile').html("");
        for(var i = 0; i < profile.length; i++) {
            employee_email = profile[i].employee_email;
            firstname = profile[i].firstname;
            lastname = profile[i].lastname;
            gender = profile[i].gender;
            salary = profile[i].salary;
            address = profile[i].address;
            working_schedule = profile[i].working_schedule;
            hotel_name = profile[i].hotel_name;

            var html = `<div class="col py-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Email: ${employee_email}</h5>
                                    <p class="card-text">Name: ${firstname} ${lastname}</p>
                                    <p class="card-text">Gender: ${gender}</p>
                                    <p class="card-text">Salary: $${salary}</p>
                                    <p class="card-text">Address: ${address}</p>
                                    <p class="card-text">Working Schedule: ${working_schedule}</p>
                                    <p class="card-text">Hotel Name: ${hotel_name}</p>
                                </div>
                            </div>
                        </div>`;

            $('#profile').append(html);
        }
    }


    function getProfile(email) {
        $.ajax({
            url : `profile_servlet?email=${email}`, // passing email as query
            method: 'GET',
            success : function(r) {
                console.log(r);
                var profile = JSON.parse(r); // json array
                displayProfile(profile);
            }
        });
    }

    function getDeskClerkProfile(email) {
        $.ajax({
            url : 'deskclerk_profile_servlet?email=' + email, // passing email as query
            method: 'GET',
            success : function(r) {
                //console.log(r);
                var profile = JSON.parse(r); // json array

                displayDeskClerkProfile(profile);

                $('.confirm-booking-btn').on('click', (event) => {
                    //console.log('Event triggered by ' + event.currentTarget.id);
                    var index = event.currentTarget.id.split('-')[1]; // index of the clicked button. with this index the chosen booking could be derived

                    var room_title = profile[index-1].room_title;
                    var hotel_name = profile[index-1].hotel_name;
                    var user_email = profile[index-1].user_email;


                    //console.log('room_title=' + room_title);
                    //console.log('email=' + hotel_name);
                    //console.log('name=' + email);

                    $.ajax({
                        url: `deskclerk_confirm_servlet?hotel_name=${hotel_name}&room_title=${room_title}&user_email=${user_email}`,
                        method: 'POST',
                        success: (r) => { alert('The booking is confirmed. Refresh the page to see the changes.'); }
                    });
                });


                $('.cancel-booking-btn').on('click', (event) => {
                    //console.log('Event triggered by ' + event.currentTarget.id);
                    var index = event.currentTarget.id.split('-')[2]; // index of the clicked button. with this index the chosen booking could be derived

                    var room_title = profile[index-1].room_title;
                    var hotel_name = profile[index-1].hotel_name;
                    var user_email = profile[index-1].user_email;


                    console.log('room_title=' + room_title);
                    console.log('email=' + hotel_name);
                    console.log('name=' + user_email);

                    $.ajax({
                        url: `deskclerk_cancel_servlet?hotel_name=${hotel_name}&room_title=${room_title}&user_email=${user_email}`,
                        method: 'POST',
                        success: (r) => { alert('The booking is canceled. Refresh the page to see the changes.'); }
                    });
                });
            }
        });
    }

    function getAdminProfile(email) {
        $.ajax({
            url : 'admin_profile_servlet?email=' + email, // passing email as query
            method: 'GET',
            success : function(r) {
                console.log(r);
                var profile = JSON.parse(r); // json array


                displayAdminProfile(profile);

                $('.change-schedule-btn').on('click', (event) => {
                    var index = event.currentTarget.id.split('-')[1]; // index of the clicked button. with this index the chosen schedule could be derived

                    var new_schedule = $('#schedule-' + index).val();
                    var employee_email = profile[index-1].employee_email;

                    //console.log('email=' + employee_email);
                    //console.log('name=' + new_schedule);

                    $.ajax({
                        url: `change_schedule_servlet?email=${employee_email}&new_schedule=${new_schedule}`,
                        method: 'POST',
                        success: (r) => { alert('The working schedule is changed. Refresh the page to see the changes.'); }
                    });
                });

                $('#btn-set-season').on('click', () => {
                    var season_name = $('#season-name').val();
                    var start_date = $('#start-date').val();
                    var end_date = $('#end-date').val();
                    var coefficient = $('#coefficient').val();

                    //console.log(season_name);
                    //console.log(start_date);
                    //console.log(end_date);
                    //console.log(coefficient);

                    $.ajax({
                        url: `set_season_prices_servlet?season_name=${season_name}&start_date=${start_date}&end_date=${end_date}&coefficient=${coefficient}`,
                        method: 'POST',
                        success: (r) => { alert('The Season Prices are set. Go to Seasons to see the changes.'); }
                    });



                });

                $('#btn-cancel-season').on('click', () => {
                    var season_name = $('#season-name').val();
                    console.log(season_name);
                    $.ajax({
                        url: `cancel_season_prices_servlet?season_name=${season_name}`,
                        method: 'POST',
                        success: (r) => { alert('The Season was deleted. Go to Bookings to see the changes.'); }
                    });
                });
            }
        });
    }

    function getEmployeeProfile(email) {
        $.ajax({
            url : 'employee_profile_servlet?email=' + email, // passing email as query
            method: 'GET',
            success : function(r) {
                console.log(r);
                var profile = JSON.parse(r); // json array

                displayEmployeeProfile(profile);
            }
        });
    }

    function deleteAllCookies() {
        var cookies = document.cookie.split(";");

        for (var i = 0; i < cookies.length; i++) {
            var cookie = cookies[i];
            var eqPos = cookie.indexOf("=");
            var name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
            document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT";
        }
    }


    $(document).ready(() => {
        //console.log(document.cookie);

        if(document.cookie) {
            var email = document.cookie.split('=')[1];
            var employee = email.split('.')[0];
            if(email == 'desk.clerk@gmail.com') {
                getDeskClerkProfile(email);
            } else if( email == 'admin.admin@gmail.com') {
                getAdminProfile(email);
            } else if( employee === 'employee') {
                getEmployeeProfile(email);
            }
            else {
                getProfile(email);
            }

            if(email) {
                $('.my-profile').html(email);
                $('.logout-btn').html('Log Out');

                $('.signup-btn').hide();
                $('.login-btn').hide();

                $('.logout-btn').on('click', () => {
                    deleteAllCookies();
                    //location.reload(); // to refresh the current page
                    window.location.href = 'index.html';
                });
            }

        } else {
            $('.signup-btn').html('Register');
            $('.login-btn').html('Login');
        }
    });
</script>
</body>

</html>